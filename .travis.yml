sudo: required

language: node_js

node_js:
  - 10

before_install:
  - pip install --user awscli
  - export PATH=$PATH:$HOME/.local/bin

script:
  - npm run ci:install
  - npm run ci:lint
  - npm run ci:test

after_success:
#  - npm run ci:publish:docker:hub
  - pip install --user awscli # install aws cli w/o sudo
  - export PATH=$PATH:$HOME/.local/bin # put aws in the path
  - eval $(aws ecr get-login --no-include-email --region us-east-2) #needs AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY envvars
  - docker build -t pdp-auth-service ./auth-service
  - docker tag pdp-auth-service:latest 933078656705.dkr.ecr.us-east-2.amazonaws.com/pdp-auth-service:latest
  - docker push 933078656705.dkr.ecr.us-east-2.amazonaws.com/pdp-auth-service:latest

cache: npm
